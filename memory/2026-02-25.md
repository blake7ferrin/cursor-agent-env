# 2026-02-25

- Session: Reviewed repo architecture and bridge setup; identified priorities around bridge state persistence, orchestrator command execution path, security hardening, and basic test/observability additions.
- Session: Implemented bridge hardening: file-backed user->agent store, authenticated `/chat` and `/agent` endpoints with rate limiting, enforced explicit `user_id`, executed parsed `SUBAGENT`/`LOCAL_ACTION` commands with allowlists, and updated bridge/PWA docs for new env vars.
- Session: Added Redis-backed persistence path (`REDIS_URL`) for agent mapping and rate limiting, refactored orchestrator dispatch into a dedicated module, and added Node test coverage for parser + dispatch with passing test run.
- Session: Discussed HVAC estimator-agent architecture; confirmed feasibility of replacing a static pricebook with a dynamic cost/rules engine plus AI intake and CRM/PDF estimate generation.
- Session: Built estimator MVP in bridge: new endpoints for config/catalog/estimate, deterministic pricing engine, printable HTML estimate output, and tests for estimate math + validation.
- Session: Added Housecall Pro CRM integration layer: auth/token handling, Housecall estimate payload mapper, export endpoint with dry-run mode, connector test/debug endpoints, docs updates, and passing tests.
- Session: Extended Housecall export with context-aware modes (`update_estimate`, `add_to_job`, `add_option_note`), appointment-based context resolution, and tests/docs for scheduled-estimate and existing-job workflows.
- Session: Added auto-upsert Housecall export routing (estimate -> appointment context -> job -> create fallback) with fallback attempt tracing and passing test suite.
- Session: Reviewed Bluon API/OpenAPI docs; determined Bluon is highly useful for diagnostics and equipment/parts enrichment, but insufficient as a direct pricing source for estimate totals.
- Session: Added `POST /estimator/changeout-plan` residential intake planner (lane classification, follow-up questions, recommended options, complexity adders, draft estimate preview) plus config/catalog extensions for margin guardrails and equipment attributes.
- Session: Confirmed user can provide full AC Pro/Day & Night pricebooks/manuals; aligned on ingestion strategy for data-plate/photo-driven residential automation with assisted quote mode for non-standard/commercial jobs.
- Session: Updated default estimator assumptions to match user baseline (`$125/hr` all-in labor, `9%` purchase tax, no permit/trip defaults, `40%` target margin, `30%` minimum margin guardrail enabled).
- Session: Confirmed gross-margin guardrail will be used as practical net-profit proxy for quoting because labor rate is fully loaded with overhead.
- Session: Searched Desktop for Cursor-relevant files and created archive \\cursor-helpful-files-2026-02-25_001113.zip\\ containing Cursor.lnk plus manifest.
- Session: Built HVAC ingestion bundle \\cursor-ingestion-hvac-2026-02-25_001317.zip\\ from Downloads with AC Pro/pricebook/spec artifacts and manifest noting missing Day & Night/options-adders/quote-sheet matches.
- Session: Added shared Google Sheet export and source link into updated bundle \\cursor-ingestion-hvac-2026-02-25_001317_with-sheet.zip\\.
- Session: Copied HVAC ingestion ZIP into workspace root for immediate sharing/use.

- Session: Continued estimator agent: unpacked cursor-ingestion-hvac-2026-02-25_001317_with-sheet.zip into bridge/imports/incoming/, added import folder structure (templates, catalog), CSV importer with validation (required fields, tonnage/system-type parsing, duplicate SKUs, cost vs price), validation report and equipment-and-adders.json catalog, npm run ingest and POST /ingest endpoint. Recorded HVAC quoting assumption and import pipeline in MEMORY.md.
- Session: Synced import pipeline commit from `main` into `cursor/hvac-pricing-agent-3304` and verified behavior (`--only CLEAN,ChangeOut_Pricebook`: 49 valid/0 errors; full ingest: 271 valid with schema errors concentrated in non-canonical CSVs).
- Session: Enhanced ingest pipeline with XLSX parsing + source profiles (`preferred`, `canonical_csv_only`) and verified preferred profile using Day & Night Google Sheet plus AC Pro canonical CSVs (258 valid, 0 errors; PDFs logged as manual references).
- Session: Wired `POST /estimator/changeout-plan` to auto-consume the preferred ingested catalog at runtime (with optional ingest refresh + catalog merge metadata), added adapter tests, and upgraded edge-case risk adders to resolve against catalog items before manual fallback.
